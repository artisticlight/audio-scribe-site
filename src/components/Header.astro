---
import { SITE, ctaUrl, hasAppStoreUrl } from '../config';
import { getTranslations, localePath, locales, localeLabels } from '../i18n/utils';
import type { Locale } from '../i18n/utils';
import DottedArrowIcon from './DottedArrowIcon.astro';

const locale = (Astro.currentLocale ?? 'en') as Locale;
const t = getTranslations(locale);
const base = import.meta.env.BASE_URL;
const lp = (path = '') => localePath(locale, path);

const ctaText = hasAppStoreUrl ? t.nav.cta : t.nav.ctaFallback;

const normalizePath = (path: string) => (path.endsWith('/') ? path : `${path}/`);
const currentPath = normalizePath(Astro.url.pathname);
const homePaths = locales.map((loc) => normalizePath(localePath(loc)));
const isHomePage = homePaths.includes(currentPath);

const desktopNavClass = [
  'text-tagline-1 flex items-center gap-1 rounded-full px-4 py-2 font-normal transition-all duration-300',
  'text-accent/80 hover:text-white hover:bg-accent/5',
].join(' ');
---

<header>
  <!-- Floating nav bar -->
  <div
    data-header-theme={isHomePage ? 'home' : 'inner'}
    class:list={[
      'header-bar lp:!max-w-[1290px] fixed top-5 left-1/2 z-50 mx-auto flex w-full max-w-[350px] -translate-x-1/2 items-center justify-between rounded-full px-2.5 py-2.5 backdrop-blur-[15px] transition-all duration-500 ease-in-out min-[425px]:max-w-[375px] min-[500px]:max-w-[450px] sm:max-w-[540px] md:max-w-[720px] lg:max-w-[960px] xl:max-w-[1140px] xl:py-0',
      isHomePage
        ? 'bg-accent/10'
        : 'bg-secondary/80',
    ]}
  >
    <!-- Logo -->
    <a href={lp()} class="flex items-center gap-3 pl-2">
      <span class="sr-only">{t.nav.home}</span>
      <span class="flex size-11 items-center justify-center rounded-full bg-white shadow-1">
        <img
          src={`${base}assets/logo.png`}
          alt={SITE.appName}
          class="h-8 w-auto"
          width="32"
          height="32"
        />
      </span>
      <span class:list={[
        'text-heading-5 font-normal leading-none hidden lg:inline',
        'text-accent',
      ]}>{SITE.appName}</span>
    </a>

    <!-- Desktop navigation -->
    <nav class="hidden items-center xl:flex" aria-label="Main navigation">
      <ul class="flex items-center">
        <!-- Product -->
        <li class="nav-item relative cursor-pointer py-2.5">
          <a
            href={`${lp()}#features`}
            class={desktopNavClass}
          >
            {t.nav.product}
          </a>
        </li>

        <!-- Resources — mega menu -->
        <li class="nav-item relative cursor-pointer py-2.5" data-menu="resources-mega-menu">
          <a
            href="#"
            class={desktopNavClass}
            aria-haspopup="true"
            aria-expanded="false"
          >
            <span>{t.nav.resources}</span>
            <span class="nav-arrow block origin-center translate-y-px transition-all duration-300">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
              </svg>
            </span>
          </a>

          <!-- Bridge element for seamless hover -->
          <div class="mega-menu-bridge pointer-events-none fixed top-full left-1/2 z-40 h-3 w-full -translate-x-1/2 bg-transparent opacity-0 lg:max-w-[1290px]"></div>

          <!-- Mega menu panel -->
          <div
            id="resources-mega-menu"
            class="mega-menu border-stroke-2 pointer-events-none fixed top-full left-1/2 z-50 mt-2 w-full -translate-x-1/2 rounded-[20px] border bg-white p-6 opacity-0 transition-all duration-300 lg:max-w-[1290px]"
          >
            <div class="grid grid-cols-12 items-start gap-y-6 md:gap-x-12">
              <!-- Column 1: Help & Documentation -->
              <div class="col-span-4 space-y-3">
                <p class="text-tagline-2 text-secondary/60 px-3 font-medium">{t.megaMenu.helpDocs}</p>
                <ul>
                  <li>
                    <a href={lp('docs/')} class="group relative flex items-start gap-2 p-3">
                      <span class="absolute inset-0 rounded-xl bg-ns-ivory/70 opacity-0 transition-opacity duration-200 group-hover:opacity-100"></span>
                      <div class="border-stroke-2 relative z-10 mt-1 flex size-7 shrink-0 items-center justify-center rounded-lg border p-1">
                        <svg class="size-4 text-secondary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 19.5v-15A2.5 2.5 0 016.5 2H20v20H6.5a2.5 2.5 0 010-5H20"/></svg>
                      </div>
                      <div class="relative z-10">
                        <p class="text-tagline-1 text-secondary font-normal">{t.megaMenu.documentation}</p>
                        <p class="text-tagline-2 text-secondary/60 font-normal">{t.megaMenu.documentationDesc}</p>
                      </div>
                    </a>
                  </li>
                  <li>
                    <a href={lp('docs/tutorials/')} class="group relative flex items-start gap-2 p-3">
                      <span class="absolute inset-0 rounded-xl bg-ns-ivory/70 opacity-0 transition-opacity duration-200 group-hover:opacity-100"></span>
                      <div class="border-stroke-2 relative z-10 mt-1 flex size-7 shrink-0 items-center justify-center rounded-lg border p-1">
                        <svg class="size-4 text-secondary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>
                      </div>
                      <div class="relative z-10">
                        <p class="text-tagline-1 text-secondary font-normal">{t.megaMenu.tutorials}</p>
                        <p class="text-tagline-2 text-secondary/60 font-normal">{t.megaMenu.tutorialsDesc}</p>
                      </div>
                    </a>
                  </li>
                  <li>
                    <a href={lp('docs/faq/')} class="group relative flex items-start gap-2 p-3">
                      <span class="absolute inset-0 rounded-xl bg-ns-ivory/70 opacity-0 transition-opacity duration-200 group-hover:opacity-100"></span>
                      <div class="border-stroke-2 relative z-10 mt-1 flex size-7 shrink-0 items-center justify-center rounded-lg border p-1">
                        <svg class="size-4 text-secondary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                      </div>
                      <div class="relative z-10">
                        <p class="text-tagline-1 text-secondary font-normal">{t.megaMenu.faq}</p>
                        <p class="text-tagline-2 text-secondary/60 font-normal">{t.megaMenu.faqDesc}</p>
                      </div>
                    </a>
                  </li>
                  <li>
                    <a href={lp('support/')} class="group relative flex items-start gap-2 p-3">
                      <span class="absolute inset-0 rounded-xl bg-ns-ivory/70 opacity-0 transition-opacity duration-200 group-hover:opacity-100"></span>
                      <div class="border-stroke-2 relative z-10 mt-1 flex size-7 shrink-0 items-center justify-center rounded-lg border p-1">
                        <svg class="size-4 text-secondary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
                      </div>
                      <div class="relative z-10">
                        <p class="text-tagline-1 text-secondary font-normal">{t.megaMenu.support}</p>
                        <p class="text-tagline-2 text-secondary/60 font-normal">{t.megaMenu.supportDesc}</p>
                      </div>
                    </a>
                  </li>
                </ul>
              </div>

              <!-- Column 2: Knowledge & Research -->
              <div class="col-span-4 space-y-3">
                <p class="text-tagline-2 text-secondary/60 px-3 font-medium">{t.megaMenu.knowledge}</p>
                <ul>
                  <li>
                    <a href={lp('knowledge/use-cases/')} class="group relative flex items-start gap-2 p-3">
                      <span class="absolute inset-0 rounded-xl bg-ns-ivory/70 opacity-0 transition-opacity duration-200 group-hover:opacity-100"></span>
                      <div class="border-stroke-2 relative z-10 mt-1 flex size-7 shrink-0 items-center justify-center rounded-lg border p-1">
                        <svg class="size-4 text-secondary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 3h6a4 4 0 014 4v14a3 3 0 00-3-3H2z"/><path d="M22 3h-6a4 4 0 00-4 4v14a3 3 0 013-3h7z"/></svg>
                      </div>
                      <div class="relative z-10">
                        <p class="text-tagline-1 text-secondary font-normal">{t.megaMenu.useCases}</p>
                        <p class="text-tagline-2 text-secondary/60 font-normal">{t.megaMenu.useCasesDesc}</p>
                      </div>
                    </a>
                  </li>
                  <li>
                    <a href={lp('knowledge/analytics/')} class="group relative flex items-start gap-2 p-3">
                      <span class="absolute inset-0 rounded-xl bg-ns-ivory/70 opacity-0 transition-opacity duration-200 group-hover:opacity-100"></span>
                      <div class="border-stroke-2 relative z-10 mt-1 flex size-7 shrink-0 items-center justify-center rounded-lg border p-1">
                        <svg class="size-4 text-secondary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
                      </div>
                      <div class="relative z-10">
                        <p class="text-tagline-1 text-secondary font-normal">{t.megaMenu.analytics}</p>
                        <p class="text-tagline-2 text-secondary/60 font-normal">{t.megaMenu.analyticsDesc}</p>
                      </div>
                    </a>
                  </li>
                  <li>
                    <a href={lp('docs/changelog/')} class="group relative flex items-start gap-2 p-3">
                      <span class="absolute inset-0 rounded-xl bg-ns-ivory/70 opacity-0 transition-opacity duration-200 group-hover:opacity-100"></span>
                      <div class="border-stroke-2 relative z-10 mt-1 flex size-7 shrink-0 items-center justify-center rounded-lg border p-1">
                        <svg class="size-4 text-secondary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polyline points="14 2 14 8 20 8"/><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                      </div>
                      <div class="relative z-10">
                        <p class="text-tagline-1 text-secondary font-normal">{t.megaMenu.changelog}</p>
                        <p class="text-tagline-2 text-secondary/60 font-normal">{t.megaMenu.changelogDesc}</p>
                      </div>
                    </a>
                  </li>
                </ul>
              </div>

              <!-- Column 3: Trust & Compliance (warm background) -->
              <div class="col-span-4">
                <div class="bg-ns-ivory/40 rounded-[10px] px-3 pb-3">
                  <p class="text-tagline-2 text-secondary/60 p-3 font-medium">{t.megaMenu.trust}</p>
                  <ul>
                    <li>
                      <a href={lp('knowledge/security/')} class="group relative flex items-center gap-2 p-3">
                        <span class="absolute inset-0 rounded-xl bg-ns-ivory opacity-0 transition-opacity duration-200 group-hover:opacity-100"></span>
                        <div class="border-stroke-2 relative z-10 flex size-7 shrink-0 items-center justify-center rounded-lg border p-1">
                          <svg class="size-4 text-secondary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                        </div>
                        <p class="text-tagline-1 text-secondary font-normal relative z-10">{t.megaMenu.security}</p>
                      </a>
                    </li>
                    <li>
                      <a href={lp('legal/gdpr/')} class="group relative flex items-center gap-2 p-3">
                        <span class="absolute inset-0 rounded-xl bg-ns-ivory opacity-0 transition-opacity duration-200 group-hover:opacity-100"></span>
                        <div class="border-stroke-2 relative z-10 flex size-7 shrink-0 items-center justify-center rounded-lg border p-1">
                          <svg class="size-4 text-secondary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                        </div>
                        <p class="text-tagline-1 text-secondary font-normal relative z-10">{t.megaMenu.gdpr}</p>
                      </a>
                    </li>
                    <li>
                      <a href={lp('legal/privacy/')} class="group relative flex items-center gap-2 p-3">
                        <span class="absolute inset-0 rounded-xl bg-ns-ivory opacity-0 transition-opacity duration-200 group-hover:opacity-100"></span>
                        <div class="border-stroke-2 relative z-10 flex size-7 shrink-0 items-center justify-center rounded-lg border p-1">
                          <svg class="size-4 text-secondary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
                        </div>
                        <p class="text-tagline-1 text-secondary font-normal relative z-10">{t.megaMenu.privacy}</p>
                      </a>
                    </li>
                    <li>
                      <a href={lp('legal/terms/')} class="group relative flex items-center gap-2 p-3">
                        <span class="absolute inset-0 rounded-xl bg-ns-ivory opacity-0 transition-opacity duration-200 group-hover:opacity-100"></span>
                        <div class="border-stroke-2 relative z-10 flex size-7 shrink-0 items-center justify-center rounded-lg border p-1">
                          <svg class="size-4 text-secondary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                        </div>
                        <p class="text-tagline-1 text-secondary font-normal relative z-10">{t.megaMenu.terms}</p>
                      </a>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </li>

        <!-- Company -->
        <li class="nav-item relative cursor-pointer py-2.5">
          <a
            href={lp('about/')}
            class={desktopNavClass}
          >
            {t.nav.company}
          </a>
        </li>
      </ul>
    </nav>

    <!-- Desktop CTA -->
    <div class="hidden items-center justify-center xl:flex gap-2">
      <!-- Language switcher -->
      <div class="relative" data-lang-switcher>
        <button
          class="flex items-center gap-1 text-tagline-2 text-accent/60 hover:text-accent transition-colors px-2 py-1 rounded-full"
          aria-label="Change language"
        >
          <span class="uppercase">{locale}</span>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-3"><path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" /></svg>
        </button>
        <div class="lang-dropdown absolute top-full right-0 mt-1 bg-white rounded-xl shadow-1 border border-stroke-2 py-1 min-w-[120px] opacity-0 pointer-events-none transition-all duration-200 z-50">
          {locales.map((loc) => (
            <a
              href={localePath(loc)}
              class:list={[
                'block px-3 py-1.5 text-tagline-2 transition-colors',
                loc === locale ? 'text-secondary font-medium bg-ns-ivory/50' : 'text-secondary/60 hover:bg-ns-ivory/30',
              ]}
            >
              {localeLabels[loc]}
            </a>
          ))}
        </div>
      </div>

      <a
        href={ctaUrl}
        class="inline-flex items-center justify-center gap-2 rounded-full border border-accent/30 bg-white px-5 py-2.5 text-tagline-1 text-secondary font-normal hover:scale-[1.02] transition-all duration-300"
        {...(!hasAppStoreUrl ? {} : { target: '_blank', rel: 'noopener noreferrer' })}
      >
        {ctaText}
        <DottedArrowIcon class="size-4 text-secondary" />
      </a>
    </div>

    <!-- Mobile hamburger -->
    <div class="block xl:hidden">
      <button
        class="nav-hamburger bg-background-4 flex size-12 cursor-pointer flex-col items-center justify-center gap-[5px] rounded-full"
        aria-label="Open menu"
      >
        <span class="bg-stroke-9 block h-0.5 w-6"></span>
        <span class="bg-stroke-9 block h-0.5 w-6"></span>
        <span class="bg-stroke-9 block h-0.5 w-6"></span>
      </button>
    </div>
  </div>

  <!-- Mobile sidebar -->
  <aside
    class="sidebar fixed top-0 right-0 z-[9999] h-screen w-full translate-x-full rounded-l-3xl bg-white transition-all duration-300 sm:w-1/2 xl:hidden overflow-y-auto"
    aria-label="Mobile navigation"
  >
    <div class="space-y-4 p-5 sm:p-8 lg:p-9">
      <div class="flex items-center justify-between">
        <a href={lp()} class="flex items-center gap-2">
          <img src={`${base}assets/logo.png`} alt={SITE.appName} class="h-8 w-auto" width="32" height="32" />
        </a>
        <button
          class="nav-hamburger-close bg-ns-ivory relative flex size-10 cursor-pointer flex-col items-center justify-center gap-1.5 rounded-full"
          aria-label="Close menu"
        >
          <span class="absolute block h-0.5 w-4 rotate-45 bg-secondary/60"></span>
          <span class="absolute block h-0.5 w-4 -rotate-45 bg-secondary/60"></span>
        </button>
      </div>

      <div class="mt-6 pb-10">
        <p class="text-secondary text-tagline-1 relative mb-2 block font-normal before:absolute before:top-1/2 before:-right-16 before:h-px before:w-full before:-translate-y-1/2 before:bg-stroke-10 before:content-['']">
          Menu
        </p>
        <ul class="space-y-2">
          <li><a href={`${lp()}#features`} class="text-tagline-1 text-secondary/60 block py-2.5 font-normal">{t.nav.product}</a></li>
          <li class="space-y-2">
            <button class="mobile-menu-toggle flex w-full cursor-pointer items-center justify-between py-2.5" data-menu="resources">
              <span class="text-secondary/60 text-tagline-1 block font-normal">{t.nav.resources}</span>
              <span class="menu-arrow transition-transform duration-300">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" fill="none">
                  <path d="M10 12L14 8L10 4" class="stroke-secondary/60" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
              </span>
            </button>
            <ul class="mobile-submenu hidden" data-submenu="resources">
              <li><a href={lp('docs/')} class="text-tagline-1 text-secondary ml-4 block py-2.5 font-normal">{t.megaMenu.documentation}</a></li>
              <li><a href={lp('docs/tutorials/')} class="text-tagline-1 text-secondary ml-4 block py-2.5 font-normal">{t.megaMenu.tutorials}</a></li>
              <li><a href={lp('docs/faq/')} class="text-tagline-1 text-secondary ml-4 block py-2.5 font-normal">{t.megaMenu.faq}</a></li>
              <li><a href={lp('support/')} class="text-tagline-1 text-secondary ml-4 block py-2.5 font-normal">{t.megaMenu.support}</a></li>
              <li><a href={lp('knowledge/use-cases/')} class="text-tagline-1 text-secondary ml-4 block py-2.5 font-normal">{t.megaMenu.useCases}</a></li>
              <li><a href={lp('knowledge/analytics/')} class="text-tagline-1 text-secondary ml-4 block py-2.5 font-normal">{t.megaMenu.analytics}</a></li>
              <li><a href={lp('docs/changelog/')} class="text-tagline-1 text-secondary ml-4 block py-2.5 font-normal">{t.megaMenu.changelog}</a></li>
              <li><a href={lp('knowledge/security/')} class="text-tagline-1 text-secondary ml-4 block py-2.5 font-normal">{t.megaMenu.security}</a></li>
              <li><a href={lp('legal/gdpr/')} class="text-tagline-1 text-secondary ml-4 block py-2.5 font-normal">{t.megaMenu.gdpr}</a></li>
              <li><a href={lp('legal/privacy/')} class="text-tagline-1 text-secondary ml-4 block py-2.5 font-normal">{t.megaMenu.privacy}</a></li>
              <li><a href={lp('legal/terms/')} class="text-tagline-1 text-secondary ml-4 block py-2.5 font-normal">{t.megaMenu.terms}</a></li>
            </ul>
          </li>
          <li><a href={lp('about/')} class="text-tagline-1 text-secondary/60 block py-2.5 font-normal">{t.nav.company}</a></li>
        </ul>

        <!-- Mobile language switcher -->
        <div class="mt-6 pt-4 border-t border-stroke-2">
          <p class="text-tagline-2 text-secondary/60 mb-2 font-medium">Language</p>
          <div class="flex gap-2">
            {locales.map((loc) => (
              <a
                href={localePath(loc)}
                class:list={[
                  'px-3 py-1.5 rounded-full text-tagline-2 transition-colors',
                  loc === locale ? 'bg-secondary text-white' : 'bg-ns-ivory text-secondary/60 hover:bg-ns-ivory/80',
                ]}
              >
                {localeLabels[loc]}
              </a>
            ))}
          </div>
        </div>
      </div>
    </div>
  </aside>
</header>

<script>
  function initNav() {
    // Desktop mega menu — hover with bridge
    const navItems = document.querySelectorAll<HTMLElement>('.nav-item[data-menu]');

    navItems.forEach((item) => {
      const menuId = item.getAttribute('data-menu');
      const menu = menuId ? document.getElementById(menuId) : null;
      const arrow = item.querySelector('.nav-arrow');
      const bridge = item.querySelector('.mega-menu-bridge');
      const trigger = item.querySelector('a[aria-haspopup]');
      let closeTimeout: ReturnType<typeof setTimeout>;

      if (!menu) return;

      const open = () => {
        clearTimeout(closeTimeout);
        menu.classList.add('active');
        item.classList.add('active');
        arrow?.classList.add('rotate-180');
        if (bridge) (bridge as HTMLElement).style.pointerEvents = 'auto';
        trigger?.setAttribute('aria-expanded', 'true');
      };

      const close = () => {
        closeTimeout = setTimeout(() => {
          menu.classList.remove('active');
          item.classList.remove('active');
          arrow?.classList.remove('rotate-180');
          if (bridge) (bridge as HTMLElement).style.pointerEvents = 'none';
          trigger?.setAttribute('aria-expanded', 'false');
        }, 150);
      };

      item.addEventListener('mouseenter', open);
      item.addEventListener('mouseleave', close);
      menu.addEventListener('mouseenter', () => clearTimeout(closeTimeout));
      menu.addEventListener('mouseleave', close);
    });

    // Language switcher
    const langSwitchers = document.querySelectorAll<HTMLElement>('[data-lang-switcher]');
    langSwitchers.forEach((sw) => {
      const btn = sw.querySelector('button');
      const dropdown = sw.querySelector('.lang-dropdown');
      if (!btn || !dropdown) return;

      btn.addEventListener('click', () => {
        const isOpen = !dropdown.classList.contains('pointer-events-none');
        if (isOpen) {
          dropdown.classList.add('opacity-0', 'pointer-events-none');
        } else {
          dropdown.classList.remove('opacity-0', 'pointer-events-none');
        }
      });

      document.addEventListener('click', (e) => {
        if (!sw.contains(e.target as Node)) {
          dropdown.classList.add('opacity-0', 'pointer-events-none');
        }
      });
    });

    // Mobile sidebar
    const hamburger = document.querySelector('.nav-hamburger');
    const hamburgerClose = document.querySelector('.nav-hamburger-close');
    const sidebar = document.querySelector('.sidebar');

    hamburger?.addEventListener('click', () => {
      sidebar?.classList.remove('translate-x-full');
      sidebar?.classList.add('translate-x-0');
    });

    hamburgerClose?.addEventListener('click', () => {
      sidebar?.classList.remove('translate-x-0');
      sidebar?.classList.add('translate-x-full');
    });

    // Close sidebar on Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !sidebar?.classList.contains('translate-x-full')) {
        sidebar?.classList.remove('translate-x-0');
        sidebar?.classList.add('translate-x-full');
      }
    });

    // Mobile submenu toggles
    const mobileToggles = document.querySelectorAll<HTMLButtonElement>('.mobile-menu-toggle');

    mobileToggles.forEach((toggle) => {
      toggle.addEventListener('click', () => {
        const menuName = toggle.getAttribute('data-menu');
        const submenu = document.querySelector(`[data-submenu="${menuName}"]`);
        const arrow = toggle.querySelector('.menu-arrow');

        if (submenu?.classList.contains('hidden')) {
          submenu.classList.remove('hidden');
          arrow?.classList.add('rotate-90');
        } else {
          submenu?.classList.add('hidden');
          arrow?.classList.remove('rotate-90');
        }
      });
    });

    // Header scroll effect
    const header = document.querySelector<HTMLElement>('.header-bar');
    const isHomeHeader = header?.dataset.headerTheme === 'home';

    const syncHeaderScrollState = () => {
      if (!header) return;
      const isScrolled = window.scrollY > 100;

      header.classList.toggle('scroll-ai-voice-header', isScrolled && isHomeHeader);
      header.classList.toggle('scroll-inner-header-offset', isScrolled && !isHomeHeader);
    };

    syncHeaderScrollState();
    window.addEventListener('scroll', syncHeaderScrollState, { passive: true });
  }

  initNav();
  document.addEventListener('astro:after-swap', initNav);
</script>

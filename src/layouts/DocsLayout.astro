---
import BaseLayout from './BaseLayout.astro';
import { getCollection } from 'astro:content';
import { getTranslations, localePath, collectionName } from '../i18n/utils';
import type { Locale } from '../i18n/utils';

interface Props {
  title: string;
  description?: string;
}

const { title, description } = Astro.props;

const locale = (Astro.currentLocale ?? 'en') as Locale;
const t = getTranslations(locale);
const lp = (path = '') => localePath(locale, path);

// Fetch docs for sidebar â€” use locale-specific collection
const docsCollection = collectionName('docs', locale) as any;
const allDocs = await getCollection(docsCollection);
const sortedDocs = allDocs.sort((a: any, b: any) => (a.data.order ?? 99) - (b.data.order ?? 99));
---

<BaseLayout title={title} description={description}>
  <section class="page-shell min-h-screen pt-[132px] pb-24">
    <div class="container-main">
      <div class="grid grid-cols-1 lg:grid-cols-[280px_1fr] gap-8">
        <!-- Sidebar -->
        <aside class="hidden lg:block">
          <nav aria-label={t.docs.sidebar} class="sticky top-28">
            <div class="space-y-1 rounded-2xl border border-stroke-10/75 bg-white/70 p-3 backdrop-blur-sm shadow-1">
              <p class="text-tagline-2 text-secondary/60 font-medium px-3 mb-3">{t.docs.sidebar}</p>
              {sortedDocs.map((doc) => (
                <a
                  href={lp(`docs/${doc.id}/`)}
                  class:list={[
                    'block rounded-xl px-3 py-2 text-tagline-1 font-normal transition-colors duration-200',
                    Astro.url.pathname.includes(doc.id)
                      ? 'bg-white text-secondary shadow-1'
                      : 'text-secondary/60 hover:bg-white/50 hover:text-secondary',
                  ]}
                >
                  {doc.data.title}
                </a>
              ))}
            </div>

            <div class="mt-6 space-y-1 rounded-2xl border border-stroke-10/75 bg-white/70 p-3 backdrop-blur-sm shadow-1">
              <p class="text-tagline-2 text-secondary/60 font-medium px-3 mb-3">{t.docs.legalSidebar}</p>
              <a
                href={lp('legal/privacy/')}
                class:list={[
                  'block rounded-xl px-3 py-2 text-tagline-1 font-normal transition-colors duration-200',
                  Astro.url.pathname.includes('legal/privacy')
                    ? 'bg-white text-secondary shadow-1'
                    : 'text-secondary/60 hover:bg-white/50 hover:text-secondary',
                ]}
              >
                {t.megaMenu.privacy}
              </a>
              <a
                href={lp('legal/terms/')}
                class:list={[
                  'block rounded-xl px-3 py-2 text-tagline-1 font-normal transition-colors duration-200',
                  Astro.url.pathname.includes('legal/terms')
                    ? 'bg-white text-secondary shadow-1'
                    : 'text-secondary/60 hover:bg-white/50 hover:text-secondary',
                ]}
              >
                {t.megaMenu.terms}
              </a>
              <a
                href={lp('legal/gdpr/')}
                class:list={[
                  'block rounded-xl px-3 py-2 text-tagline-1 font-normal transition-colors duration-200',
                  Astro.url.pathname.includes('legal/gdpr')
                    ? 'bg-white text-secondary shadow-1'
                    : 'text-secondary/60 hover:bg-white/50 hover:text-secondary',
                ]}
              >
                {t.megaMenu.gdpr}
              </a>
            </div>
          </nav>
        </aside>

        <!-- Content -->
        <article class="prose-custom page-content-card p-8 md:p-12">
          <slot />
        </article>
      </div>
    </div>
  </section>
</BaseLayout>

<style is:global>
  .prose-custom h1 {
    font-size: var(--text-heading-3);
    line-height: var(--text-heading-3--line-height);
    font-weight: 500;
    color: var(--color-secondary);
    margin-bottom: 1rem;
  }

  .prose-custom h2 {
    font-size: var(--text-heading-5);
    line-height: var(--text-heading-5--line-height);
    font-weight: 500;
    color: var(--color-secondary);
    margin-top: 2.5rem;
    margin-bottom: 0.75rem;
  }

  .prose-custom h3 {
    font-size: var(--text-heading-6);
    line-height: var(--text-heading-6--line-height);
    font-weight: 500;
    color: var(--color-secondary);
    margin-top: 2rem;
    margin-bottom: 0.5rem;
  }

  .prose-custom p {
    font-size: var(--text-tagline-1);
    line-height: var(--text-tagline-1--line-height);
    color: var(--color-text-secondary);
    margin-bottom: 1rem;
  }

  .prose-custom ul,
  .prose-custom ol {
    padding-left: 1.5rem;
    margin-bottom: 1rem;
  }

  .prose-custom li {
    font-size: var(--text-tagline-1);
    line-height: 1.75;
    color: var(--color-text-secondary);
  }

  .prose-custom strong {
    color: var(--color-secondary);
    font-weight: 600;
  }

  .prose-custom em {
    color: var(--color-text-secondary);
  }

  .prose-custom code {
    font-size: 0.875em;
    background: var(--color-background-3);
    border-radius: 0.375rem;
    padding: 0.125rem 0.375rem;
  }

  .prose-custom pre {
    background: var(--color-secondary);
    color: var(--color-accent);
    border-radius: 0.75rem;
    padding: 1.25rem;
    overflow-x: auto;
    margin-bottom: 1.5rem;
  }

  .prose-custom pre code {
    background: none;
    padding: 0;
  }

  .prose-custom a {
    color: var(--color-ns-linen);
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  .prose-custom a:hover {
    color: var(--color-secondary);
  }

  .prose-custom hr {
    border-color: var(--color-stroke-2);
    margin: 2rem 0;
  }
</style>
